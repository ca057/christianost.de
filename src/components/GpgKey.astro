---
import "../styles/variables.css";
import { gpgKey } from "../data/gpg-key";
import Code from "../components/Code.astro";
import TextButton from "../components/TextButton.astro";
import IconButton from "../components/IconButton.astro";
import * as Icon from "@astropub/icons";

const buttonOpenId = "gpg-key_btn-open";
const buttonCloseId = "gpg-key_btn-close";
const buttonCopyId = "gpg-key_btn-copy";
const dialogId = "gpg-key_dlg";
---

<TextButton id={buttonOpenId}>
  <slot>GPG key</slot>
</TextButton>

<dialog id={dialogId} data-a11y-dialog={dialogId}>
  <div>
    <div class="row">
      <IconButton id={buttonCopyId}>
        <Icon.Copy size="24" />
      </IconButton>
      <IconButton id={buttonCloseId}>
        <Icon.Cross1 size="24" />
      </IconButton>
    </div>
    <div id="key">
      <Code>{gpgKey}</Code>
    </div>
  </div>
</dialog>

<script
  defer
  src="https://cdn.jsdelivr.net/npm/a11y-dialog@7/dist/a11y-dialog.min.js"
></script>

<script
  define:vars={{
    buttonOpenId,
    buttonCloseId,
    buttonCopyId,
    dialogId,
    gpgKey,
  }}
>
  const dialog = document.getElementById(dialogId);

  const openButton = document.getElementById(buttonOpenId);
  openButton.addEventListener("click", () => {
    openButton.blur();
    dialog.showModal();
  });

  document.getElementById(buttonCloseId).addEventListener("click", () => {
    dialog.close();
  });

  document.getElementById(buttonCopyId).addEventListener("click", async () => {
    if (!navigator.clipboard) {
      // TODO: show error
      return;
    }
    try {
      await navigator.clipboard.writeText(gpgKey);
      // TODO: show success
    } catch (error) {
      // TODO: show error
    }
  });

  dialog.addEventListener("click", (event) => {
    if (event.target.nodeName === "DIALOG") {
      dialog.close();
    }
  });
</script>

<style>
  /* TODO: backdop style */
  @media (prefers-reduced-motion: no-preference) {
    @keyframes slide-in-up {
      from {
        transform: scale(0.85) translateY(15%);
      }
    }

    dialog[open] {
      animation: slide-in-up 0.2s ease-out forwards;
    }
  }

  dialog {
    border: 4px solid var(--color-text);
    border-radius: 8px;
    padding: var(--spacing);
    background-color: var(--color-bg-1);
  }

  dialog > div {
    display: flex;
    flex-direction: column;
  }

  .row {
    display: flex;
    flex-direction: row;
    justify-content: flex-end;
  }

  #key {
    grid-area: key;
  }
  #gpg-key_btn-close {
    grid-area: close;
  }
  #gpg-key_btn-copy {
    grid-area: copy;
  }
</style>
